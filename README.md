## 1. 介绍

一个简单的小插件/Python 脚本，支持 ImageJ 1 和 2(Fiji)，用来通过一张预先拍摄的平场图像从样本图像中减去污渍，两张图片的亮度不一定需要相同。本质上，该插件实际上是自动化执行了以下过程：

1. 对于平场图像 -> 获得实际的“污渍”反向像素灰度图像：invert(因为对于明亮背景有时候背景消除效果不佳) -> Subtract background(半径为图像宽度) 
2. 对于获得的“污渍”图像 -> 提取污渍特征区域(避免噪声和未完全减去的背景等二值化后黏连导致额外的污渍识别)并统计其与周围环境的相对值：Auto Threshold(滤除噪点小颗粒等) -> [可选] ParticleAnalyzer 滤除离群值（对于手动处理，你可以通过调节 Threshold 以省略该步，或者手动运行 Process-Noise-Remove Outliers 并调节参数，或手动运行 Process-Noise-Despeckle 并据效果控制作为替代） -> 计算遮罩区域与遮罩周围区域像素平均值相对值
3. 对于样本图像 ：使用相同的特征区域遮罩统计该图污渍与周围环境区域像素平均值相对值，获得平场污渍与样本图像污渍之间亮度关系系数，通过该系数进行图像相加运算。

实际上，你也可以自行手动执行以上过程以更好地控制中间参数。此时，实际上只需要执行第一步以后，大概评估两图像相对值比例（通过将鼠标移到两图像同一较为显著污渍区域及周围区域，直接查看 imagej 状态栏显示的像素值，估测差值后估算差值比例），用 Calculator Plus 插件(若有)使用该系数进行相加运算(因为已 invert)即可，或者手动先执行 Math-Multiply 后再用 Image Calculator 相加亦可。或者仍然可以手动执行 2、3 步获得相对精准比值。因此，本插件某种程度上主要是为了解决多图时“自动”评估亮度关系并减去污渍的问题。

**使用方法：** 从Release中下载jar，复制到ImageJ/Fiji的根目录下的plugins文件夹中，重启ImageJ/Fiji，随后你可以通过Process > Remove Dirty Stains使用该插件。你需要先打开平场图像和待处理图像，然后运行该插件，在下拉框中选择对应图像即可，参数一般不需要调节。

或者你也可以从根目录或release中下载remove_stains_*.py文件，这是使用python语言编写的脚本，能与本插件实现相同的功能。

如果你想要自行编译本插件，可以下载整个jar-src文件夹，在安装Maven环境后进入该目录（包含pom.xml），使用`mvn clean package`命令进行打包为jar文件。

**理论上来说，本插件只支持明场图像，并且目前只支持灰度图像。本插件主体部分主要是为了实现特定污渍的移除，并没有处理光照不均的情况，因此如果你想像平场校正一样处理光照不均，应当在执行本插件后再次运行伪平场校正。**

----

实际上写这个插件是因为一开始找在ImageJ中进行平场校正方法时，中文结果中没有特别准确的结果，一些教程中对诸多概念也存在混淆，并且实际上是为了通过平场校正移除图像中的固定的污渍（而不是更多地用于光照不均矫正）。后来在英文结果中找到了一些他人已经开发好的插件和原理[^3]，但是不知道为什么，在一些图像中运行的结果在污渍的边缘不佳（可能是因为平场图像中污渍因为焦面变化产生变化的原因，见后文讨论），因此想到了这个方法，在进行尝试后，至少在我们的显微镜及其拍摄的一系列图片中具有比较好的效果，因此，也同时是为了体验开发ImageJ插件的过程、以及记录对于平场校正、暗场矫正、成像过程相关内容的学习，特此撰写此文档并开发了此插件。

考虑到当前中文内容中对于显微学术图像平场校正原理和方法讨论的不是那么多，以及当前许多讨论中并不完备，因此在此文档中花费很大的篇幅讨论了当前平场校正的一般方法的原理，并探讨了不同情况话对于校正后图像的影响。**事实上，前人关于该问题已经开发了许多新的方法**（例如doi:10.1145/1661412.1618490，但我好像没有找到直接提供的相关插件，也没有认真读那篇文章） **，关于平场校正的方法也不仅限于本文中介绍的“一般”平场校正，此处仅是作为学习记录与抛砖引玉；笔者本身也不是相关专业研究人员，所写内容可能有谬误，敬请指正。**

关于该方法科学性、特点、优点和缺点的讨论，请详见本文最后一部分。一个物理污渍，其物理本质可能是是乘性（主要）或者与加性叠加导致的衰减，而针对这种信号衰减的情况，虽然从可能上应该考虑同样用乘性（主要）或加性共同的方法进行回复，但由于讨论中提到的一系列问题（例如随机噪点的引入、对于污渍位置精确性的限定），我们也可以考虑另一种有效的 **修复策略可以是直接进行加性的“填补”或“补偿”** ，也就是该插件提出的方法。虽然具体量化的科学性可能需要进一步具体考察，但至少对于明场图像来说，一般只作为示意使用，视觉效果可能是更多需要考虑的问题。

而从对于视觉角度考虑，本方法的鲁棒性至少从主观上感觉是要比传统平场校正移除物理污渍的鲁棒性好的。尤其是，虽然我们在后文讨论中认为平场图像与样本图像亮度不同对于平场校正可能没有影响，但是实际上操作时不知道为什么，传统平场校正出来有时候就是会出现污渍区域亮度不对的情况（虽然也不经常是），我们选择了其中一张会出现这种情况的图像作为对比（处理时为16bit灰度tif，上传考虑处理后图像已压缩并转为8bit jpg）：

| 原图 | 平场图像 | 本方法 | 经典单平场校正方法 |
| :----: | :----: | :----: | :----: |
| <img src=".\README-Image\Example\Sample.jpg" style="zoom: 33%;" /> | <img src=".\README-Image\Example\Flat.jpg" style="zoom: 33%;" /> | <img src=".\README-Image\Example\Cleaned_Sample.jpg" style="zoom: 33%;" /> | <img src=".\README-Image\Example\FFC_Sample.jpg" style="zoom: 33%;" /> |

可以看到在这个样本中经典但平场矫正方法处理得并不好，明显的污渍区域处理后反而被增量了，同时整体的画面亮度也变低了。

然而，不知道为什么，尽管有的图像看上去和上一个例子视觉上似乎是比较类似的，但经典单平场校正方法又能处理得很好，不过本方法同样在视觉上具有很好的效果（处理时为16bit灰度tif，上传考虑处理后图像已压缩并转为8bit jpg）：
| 原图 | 平场图像 | 本方法 | 经典单平场校正方法 |
| :----: | :----: | :----: | :----: |
| <img src=".\README-Image\Example\Sample2.jpg" style="zoom: 33%;" /> | <img src=".\README-Image\Example\Flat2.jpg" style="zoom: 33%;" /> | <img src=".\README-Image\Example\Cleaned_Sample2.jpg" style="zoom: 33%;" /> | <img src=".\README-Image\Example\FFC_Sample2.jpg" style="zoom: 33%;" /> |

不过，不论哪个样本，经过经典单平场校正后视觉上亮度似乎都会变弱，这可能是正是因为经典平场矫正会导致处理后的图像信号被乘上了一个小于1的系数的原因（见后文原理中详细讨论）

----

关于该插件的英文命名，一般来说英文中喜欢把这些物理污渍统称“Artifacts”/"Patterns"，但是翻译为伪影/模式之后在中文中可能更多地倾向于指一种不应该出现的模式，并且这些模式的出现可能更多地是因为信号处理等原因导致的，例如振铃伪影、Blocking artifact等，但个人认为污渍就不能完全算是“模式”，因为本质上它是物理实体因素导致的，而不是完全是一些纯粹的光学或信号处理因素，并且从直接表意上来说“影”更多地可能传达普遍的、全局的，或者边缘模糊的污渍的影响，因此我更倾向于说“污渍”而不是“伪影”或“模式”，但是英文中污渍的直译是stain，这对于显微照片来说，生物做染色的英文也叫stain，可能导致歧义，所以我将该方法称为remove dirty stain。

（吐槽：LATEX真好用，Markdown就没有那么好用了，不知道为什么那么多人喜欢用，尤其是不同地方实现Markdown的方式不一样，支持的格式细节也不一样，本来写好的文档放到github上又渲染不出来，又调了一下午。最后发现github的markdown大抵就是不支持行间公式缩进的（因为公式在多级列表中，如果其中一级包含多段，只有第一段想要列表符号，后面几段不想要，但也想保持缩进等级，那么就必须所有需要保持缩进等级的段开头都要加上相同的空格），但是因为公式不支持缩进，只有开头没有空格才能渲染，但是公式开头没空格就会导致公式后面仍然想保持缩进但没列表符号的段无法保持，唯一可能通过对公式标识使用"$$\\"能够勉强实现，但是这会导致行间公式不居中，而且该效果不稳定。所以最后没办法了，只能自行在需要在公式后边还要缩进的段自己加空格。但是渲染器又会自动把空格删掉，试了几种都不行，最后发现得加`&#x2003;`才可以。然后github的markdown对上标下标顺序也有要求，好像上标只能在下标后面，不然莫名其妙渲染不出来。总之很讨厌。可能markdown只适合用来写代码，不适合用来写公式 (。＿ 。））

（另外，本篇文章中公式中的撇号“'”都不是指导数，就是用来标识变了一下的意思。（所以github的渲染器默认还会把撇号弄得高高的，也很讨厌x）

<br/>

## 2. 通用平场校正方法介绍

### 2.1 背景知识：信号获取过程概述及其中的非信号部分的产生

#### 2.1.1 传感器成像流程

<center>【光子】 -> 感光材料（光电效应） -> 【电子】 -> FDA（浮置扩散放大器） -> 【电压（模拟信号）】 -> ADC（模数转换器） -> 【ADU（灰度值、数字信号）】</center>

<center>
<img src=".\README-Image\pixel-emva1288.webp" alt="https://www.teledynevisionsolutions.com/globalassets/industrial/discover/machine-vision/how-to-evaluate-camera-sensitivity/pixel-emva1288.jpg" style="zoom:80%;" />
<img src=".\README-Image\EMVA1288-Linear-4.0.svg" alt="[EMVA1288-Linear-4.0](https://www.emva.org/wp-content/uploads/EMVA1288Linear_4.0Release.pdf)" style="zoom:10%;" />
</center>

<center>示意图来源参见全文最后 (See the end of the full text for the source of the diagram)</center>

**光电转换** ：当 $`\mu _p`$ 个光子进入像元时，它必须进入光敏面（photosensitive substrate）。该过程由菲涅尔方程控制，并根据折射率、各种材料和AR膜（AR =抗反射）决定进入光敏面的光量。这被称为外部量子效率（External QE (Quantum efficiency)）。一旦进入光敏面，光子就会被吸收，并通过光电子效应产生电子/空穴对。电场将载流子扫入存储结构。吸收深度（absorption depth）和电场的影响深度（depth of influence of the electric fields）（这两个深度可能不一致）决定了内部量子效率（Internal QE），并非所有转换后的光子的载流子都会被收集。
> 像元是相机芯片上的最小感光单元，每个像元对应图像上的一个像素。可译作sensor pixel，概念上可通过与译作image pixel的表示实际图像的“像素”区分。一些场合中也直接译作pixel，不区分传感器的像元与最终获得图像的像素，都称作像素。
> 
> 载流子（charge carrier）又称电荷载子，简称载子（carrier），指可以自由移动的带有电荷的物质微粒，如电子和离子。 在半导体物理学中，电子流失导致共价键上留下的空位（空穴）被视为载流子。 在电解质溶液中，载流子是已溶解的阳离子和阴离子。

该过程中收集到 $`\mu _e`$ 个载流子，总量子效率为 $`\eta =\frac{\mu _e}{\mu _p}`$ ，这些载流子被带到感测节点并转换成电压。这种转换（载流子到电压）的发生位置取决于传感器的类型，例如 CCD 或 CMOS 图像传感器。两种传感器都利用硅材料的光电效应。当光子撞击传感器像素时，会被硅吸收，产生电子-空穴对 。产生的电子数量与入射光的强度成正比，这些电子被收集起来，构成了图像信号的基础 。


- **CCD（Charge-Coupled Device，电荷耦合器件）传感器** ：其像素核心通常是MOS（金属-氧化物-半导体）电容器结构，用于在曝光期间收集和存储光生电子于势阱中。曝光结束后，通过精确控制施加在相邻电极上的电压脉冲，这些存储在像素中的电荷包会像“接力传递”一样，在像素阵列中逐行、逐列地顺序转移（charge coupling），最终被输送到位于传感器边缘的一个或少数几个输出节点。在输出节点，累积的电荷被统一转换为电压信号，该模拟信号随后经过放大、缓冲，并通常在芯片外部由ADC完成数字化。由于所有像素的电荷都通过相同的读出电路转换，CCD通常具有较高的信号均匀性和较低的固定模式噪声（FPN）。CCD的架构（如全帧型Full-Frame、帧转移型Frame-Transfer、行间转移型Interline-Transfer）决定了其不同的操作特性，例如全帧型CCD通常需要机械快门以防止图像在读出时产生拖影（smear），而行间转移型CCD则通过将部分像素面积用于遮光存储和快速转移电荷来实现电子快门，但这会牺牲一部分填充因子（fill factor）。CCD通常具有较高的填充因子和良好的动态范围，但其串行读出方式限制了读出速度，且功耗相对较高，制造工艺也较为特殊和昂贵。
- **CMOS（Complementary Metal-Oxide-Semiconductor，互补金属氧化物半导体）传感器** ：其核心是主动像素传感器（Active Pixel Sensor, APS）架构。每个像素内部除了光电二极管用于收集光生电荷外，还集成了至少三个晶体管：一个用于复位像素（reset transistor），一个源跟随器用于将电荷在像素内直接转换为电压信号并进行放大（amplifier/source follower），以及一个行选择晶体管（row select transistor）用于寻址读出。与CCD不同，这意味着电荷到电压的转换在每个像素处独立完成。读出时，通过寻址逻辑选择特定行，该行所有像素的电压信号通过列并行总线（column parallel buses）同时读出，通常每列配备独立的放大器和ADC，或者多列共享ADC，从而实现高速并行处理。因此，CMOS传感器通常能直接输出数字信号，并易于集成如时序控制、噪声抑制、甚至更复杂的图像处理功能于同一芯片上（System-on-Chip, SoC），从而降低了系统复杂度和功耗，制造成本也更低。CMOS传感器可以实现电子滚动快门（rolling shutter，逐行曝光和读出，可能导致运动物体变形）或全局快门（global shutter，所有像素同时曝光并在内部存储电荷，然后统一读出，避免运动失真，但像素结构更复杂）。
- 传统上，CCD在低光照条件下表现更优，具有更高的量子效率（QE）和更低的噪声，能捕捉到更微弱的光信号 。其结构允许大部分像素面积用于感光 。早期CMOS由于像素内电路占据了一部分面积（填充因子较低），其光敏面积相对较小，导致灵敏度不如CCD 。然而，随着技术进步，特别是背照式（Backside Illumination, BSI）CMOS传感器的出现，通过将布线层移到感光区域下方，极大地提高了CMOS的填充因子和量子效率，使其在低光性能上已能与CCD媲美甚至超越 。由于其高度一致的制造工艺和单点读出，CCD的FPN通常非常低 。早期CMOS的FPN（包括暗信号非均匀性DSNU和光响应非均匀性PRNU）比较显著，主要源于像素间和列间放大器特性的差异 。现代CMOS通过更精密的制造和片上校正技术已大幅改善FPN。

**模数转换器（ADC，Analog To Digital Convertor）**：将**连续**时间和**连续**幅度的模拟信号（电压）转换为**离散**时间和 **离散** 幅度的数字信号（灰度值）。

**模拟数字单位（ADU，Analog-Digital Units）** ：也称DN（Digital Number）或灰度值，是经过ADC转换后得到的数字信号的量化单位。在一个具有特定位数（如 $`N`$ 位ADC）的系统中，每个像素的ADU值是一个整数，通常范围在 $`0`$ 到 $`2^N-1`$ 之间。

**增益（Gain）** ：增益描述了从收集到的光生电子（e-）到最终输出的数字单位（ADU）之间的转换系数，这个放大倍数称为增益 $`K`$ （转换增益），反映了信号被放大的程度。

- 转换增益：表示需要多少个电子信号才能在ADC上升高1个数字灰度级（ADU），单位是e-/ADU。例如，若某相机的转换增益为 6 e⁻/ADU，则每多积累 6 个电子，其输出灰度级上升 1。一般来说，讨论传感器时默认提到的增益指转换增益。
- 量化增益/灵敏度：相机厂家通常会把转换增益（e-/ADU）转换为方便日常使用的整十整百的数值，这种量化增益通常与增益成反比，即ADU/e-，即转换增益的倒数，即每多1个电子，对应输出多少ADU。一般来说，用户界面中看到的增益一般指量化增益，数码相机的感光度ISO也应属于一种量化增益。
- ”增益“一词在不同的场合有不同的定义和单位，例如在电子学中，可能也使用dB作为单位描述描述模拟放大器对信号的放大倍数，公式为 $`Gain_{dB}=10log_{10}(\frac{I_{out}}{I_{in}})\ dB`$ 。在某些天文相机驱动中，可能使用dB描述模拟放大环节的相对增益。

**偏置（Bias）/ 偏移（Offset）** ：由于读出噪声等的存在，信号为零时可能会读出负值（见后文读出噪声部分），这在软件处理上不便。因此科学相机为了确保即使在信号为零或存在负向噪声波动时，像素读出值也不会出现负数，通常会在每个像素的最终输出上人为添加一个固定的直流偏移量，例如100 e-。这个即使在没有光照和零曝光时间下每个像素依然具有的非零基线值，就是偏置。这种偏置本身可能存在空间上的不均匀性，即不同像素的偏置值可能不同（例如对于CMOS主要是行列间的）。

**暗电流（Dark Current）**：指即使没有光子进入器件，也会流过光电倍增管、光电二极管或电荷耦合器件等光敏器件的相对较小的电流 ；它由探测器在没有外部辐射进入探测器时产生的电荷组成[^1]，单位通常是电子/像素/秒 (e-/(s•pixel))。产生原因大致可以阐述为源于半导体材料（通常是硅）内部电子的热骚动 ：在一定温度下（即使是室温也足够了），硅晶格中的价带电子会获得足够的热能，跃迁至导带，从而形成电子-空穴对，这些自发产生的电子构成了暗电流的基础 。半导体晶格中的缺陷或硅-二氧化硅（Si-SiO2）界面处的缺陷会显著促进这种热生过程 ，因此，温度和曝光时间（长时间曝光导致暗电流积累）是对于暗电流主要的影响因素。 **暗噪声的起源是暗电流（随机暗噪声是暗电流的一部分），暗噪声是由暗电流的变化引起的，它们不是同一个概念** [^2]。“暗电流”描述的是电子产生的速率，但“暗信号”才是传感器在一次曝光后实际测量到的物理量。正是这个暗信号，在其空间分布上表现出不均匀性（即暗信号非均匀性，DSNU），并在其时间演化上表现出随机波动（即暗散粒噪声）。

> 暗电流详细来说，可以分为以下几个部分，它们都与温度有关，尽管其依赖关系的强度和形式可能不同。
> - 扩散电流 (Diffusion Current)：由器件中性区（P型和N型材料的未耗尽区域）内产生的少数载流子扩散到耗尽区边缘并被电场扫过而形成的电流，这些少数载流子的产生主要是热激发的结果。
> - 产生-复合电流 (Generation-Recombination Current)：在PN结的耗尽区内，由于热激发产生的电子-空穴对被强电场分离而形成的电流。这通常通过肖克利-里德-霍尔（SRH）缺陷能级进行。
> - 表面漏电流 (Surface Leakage Current)：在器件表面或边缘，由于表面态、污染物或缺陷等原因形成的导电通路产生的电流。表面漏电流的机制比较复杂，可能包含多种成分：
>   - 表面产生电流：类似于耗尽区内的产生电流，但发生在半导体表面或Si-SiO₂界面处的表面态。这个过程也依赖于通过热激发产生电子-空穴对。
>   - 离子导电：表面污染物或封装材料中的可动离子在电场作用下迁移形成的电流，离子迁移率通常随温度升高而增加。
>   - 欧姆性漏电：如果表面存在固定的导电通路（可等效为一个电阻 $`R`$ ），则漏电流为 $`V_{bias}/R`$  。半导体材料的电阻率通常随温度升高而降低（因为载流子浓度增加），这意味着R可能随温度升高而减小，从而导致漏电流随温度升高而增大。 因此，表面漏电流通常也表现出随温度升高而增大的特性，尽管其具体的温度依赖函数可能不像扩散电流或产生电流那样有单一、明确的指数形式，而是多种机制叠加的结果。其基本描述侧重于“通路”，但这些通路上的载流子产生和迁移能力往往与温度有关。
> - 隧穿电流 (Tunneling Current)：在高反向偏压或存在高浓度缺陷时，载流子可能通过量子隧穿效应直接穿过势垒形成的电流（例如带间隧穿或缺陷辅助隧穿）。
>   - 直接带间隧穿 (Band-to-Band Tunneling, BTBT)：主要取决于电场强度（由反向偏压和掺杂浓度决定）和禁带宽度 $`E_g`$  。其对温度的直接依赖性相对较弱。但是，禁带宽度 $`E_g`$ 本身会随温度的升高而略微减小，这可能导致隧穿概率略微增加，从而使BTBT电流随温度升高有微弱的增长。
>   - 缺陷辅助隧穿 (Trap-Assisted Tunneling, TAT)：载流子通过隧穿进入或离开位于禁带中的缺陷能级。这个过程可能涉及到缺陷能级的热激发或俘获步骤，因此其温度依赖性可能比纯BTBT更强一些，介于纯隧穿和纯热产生机制之间。 总的来说，隧穿电流的温度敏感性通常远低于由热产生机制主导的扩散电流和产生-复合电流。但在极低温或极高电场下，隧穿电流可能成为暗电流的主要来源。
> - 在一些特定或极端情况下，可能还需要考虑：
>   - 雪崩倍增前的碰撞电离 (Pre-avalanche Impact Ionization)：在较高的反向偏压下，即使未达到雪崩击穿电压，部分获得足够能量的载流子也可能通过碰撞产生新的电子-空穴对，从而增加暗电流。这可以看作是暗电流的一种放大。
>   - 器件边缘效应和封装相关漏电 (Device Edge Effects and Package-Related Leakage)：除了前面提到的表面漏电流，器件边缘的切割、钝化处理以及封装材料和工艺也可能引入额外的漏电通路。
>   - 光致漏电流的残留 (Residual Photo-induced Leakage)：如果器件之前暴露在强光下，一些长寿命的陷阱可能被填充，随后缓慢释放载流子，表现为一种衰减的“暗”电流，但这更像是一种瞬态效应。

#### 2.1.2 成像过程中产生的噪声/非预期信号

在上述过程中，不可避免地会引入各种噪声。这些噪声可以大致分为时域随机噪声和空域固定模式噪声。

- **时域噪声（Temporal Noise）/随机噪声（Random noise）** ：这类噪声在时间上是随机变化的，即对于同一像素，在不同时间点或不同帧图像中其噪声值是不同的。通过对多帧图像进行平均可以降低这类噪声。
  
    - **光子散粒噪声（Photon Shot Noise）** ：源于光的粒子性和光子到达的统计不确定性。即使是稳定的光源，其发射的光子数在极短时间内也存在随机波动；同时，光子到达传感器光敏面的过程也是随机的（例如光子到达传感器时并非整齐排列）。这种波动遵循泊松分布，其噪声大小（标准差）等于平均收集光子数的平方根 ( $`\sqrt{\mu_p \cdot \eta}`$ ，其中  $`\mu_p \cdot \eta = \mu_e`$  为平均光电子数)。因此，信号越强（光电子数越多），散粒噪声的绝对值也越大，但信噪比（SNR =  $`\mu_e / \sqrt{\mu_e} = \sqrt{\mu_e}`$ ）会提高。
    - **读出噪声（Read Noise / Readout Noise）**：指在将像素中收集到的电荷（光电子和暗电子）转换为数字信号（ADU）的过程中，由读出电路（包括放大器、ADC等）引入的随机电子波动。这种噪声在每次读出操作时都会叠加到信号上，其大小通常以电子数均方根 (e- RMS) 为单位。读出噪声与入射光强和曝光时间基本无关，是传感器固有的一个性能参数。 **量化噪声（Quantization Noise）** 是ADC将连续模拟信号转换为离散数字级别时产生的误差，有时也被包含在广义的读出噪声中，或作为其一个组成部分。
    - **暗电流散粒噪声（Dark Shot Noise / Temporal Dark Noise）** ：由于暗电流的产生也是一个随机的泊松过程，因此在特定曝光时间内累积的暗电子数量会围绕其平均值 ( $`\mu_d`$ ) 产生统计波动。这种随时间随机波动的噪声即为暗电流散粒噪声，其大小（标准差）等于平均暗电子数的平方根 ( $`\sqrt{\mu_d}`$ )。它是时域噪声的一种，会随曝光时间和温度的增加而增大（因为  $`\mu_d`$  会增大）。
    
- **空域噪声 / 固定模式噪声（FPN，Fixed Pattern Noise）/模式噪声（Pattern noise）/模式（Patterns）/伪影（Artifacts）** ：这类噪声在空间上是固定的或缓慢变化的，即特定像素或区域总是表现出比周围像素更亮或更暗的固定模式。FPN在帧与帧之间基本保持不变，因此不能通过简单的多帧平均去除，反而可能因平均而更加明显。FPN主要影响CMOS传感器，但CCD也可能存在少量。
  
    - **暗信号非均匀性（DSNU，Dark Signal Non-Uniformity）** ：指在无光照条件下，传感器不同像素输出信号（暗信号）的差异，表现为图像上固定的亮暗像素图案。DSNU是固定模式噪声的一种，它本身可以由两个主要因素引起：
      
        - **偏置非均匀性（Bias Non-Uniformity / Offset FPN）** ：即使在零曝光时间下，由于制造工艺差异（如CMOS传感器中每列或每个像素的放大器、复位晶体管等特性不完全一致），不同像素的基线偏置（Bias）值也会存在差异。这种差异形成了固定的空间图案，例如常见的列条纹噪声。
        - **暗电流产生速率非均匀性（Dark Current Generation Rate Non-Uniformity）** ：不同像素由于材料缺陷、杂质浓度等物理特性的微小差异，其暗电流的产生速率并不相同。这导致在一定的曝光时间和温度下，不同像素累积的平均暗电子数不同，从而形成固定的暗信号图案。例如“热像素”（hot pixels，暗电流远高于平均值）和“冷像素”（cold pixels，暗电流远低于平均值）就是这种非均匀性的极端表现。
        
        DSNU会受到相机传感器温度和曝光时间的影响，因为暗电流的累积及其非均匀性贡献会随这两个参数的增加而更加显著。DSNU通常通过暗场校正（减去相同条件下获取的平均暗场图像）来补偿。
        
    - **光响应非均匀性（PRNU，Photo Response Non-Uniformity）** ：指传感器不同像素对相同光照强度响应（即光电转换增益）的差异。即使在均匀光照下，不同像素输出的信号值也会因其光敏度和增益的不同而产生差异，形成一种乘性的固定图案噪声。PRNU与光照强度有关，通常表示为平均信号的一个百分比。PRNU主要通过平场校正（Flat-Field Correction）来补偿。

**关于“暗电流”和“暗噪声”的进一步说明** ：
“暗电流”本身是指在无光条件下传感器内产生的物理电流（单位时间内产生的电子数）。而“暗噪声”则是指由暗电流引起的信号变化或不确定性。这主要包括：

1.  **暗电流散粒噪声（Temporal Dark Noise / Dark Shot Noise）** ：如前所述，这是暗电流在时间上的随机泊松波动。
2.  **暗信号非均匀性（DSNU，一种Spatial/Fixed Pattern Noise）** ：这是暗电流（包括其累积的信号和偏置本身）在空间上的不均匀分布。

因此，说暗电流是FPN（特指DSNU中的暗电流不均匀性部分）或说暗噪声是时域随机的（特指暗电流散粒噪声）都有其道理，关键在于明确讨论的是暗电流的哪个方面或由其引发的哪种噪声成分。

### 2.2 当前一般平场校正与暗场矫正算法及原理

基于上述对于信号中非信号部分的去除的描述，我们在此阐述当前一般使用的普通的平场校正与暗场矫正算法。

#### 2.2.1 定义

我们定义一张图像像素值由下式得到：

$$ P(x,y)=I(x,y) \cdot F(x,y)+Q(x,y)+N(x,y) $$  

其中 $`I(x,y) \in [0,传感器接受上限]`$ 表示假设没有其他因素影响，传感器理应接收到的物体点实际光强度（无论是明场的透射光还是荧光的自发光）， $`F(x,y) \in [0,1]`$ 代表该位置的由于光学系统和传感器实际性能等影响的系统（综合）响应系数（乘性因子）， $`Q`$ 代表非随机加性偏移信号， $`N`$ 代表时域随机噪声。由于时域随机噪声很少，并且相对较难通过此处简单运算的方法去除，因此在后文讨论中我们暂且忽略，因此有：

- **暗场图像：** 在暗场矫正中，一般会涉及到“偏置帧”或“暗帧”的概念。下文为了表述的通用性，将用于校正的背景帧统一记为 $`P_{Bkg}(x,y)`$ ，根据具体情况代表  $`\bar{P}_{Bias}(x,y)`$  或  $`\bar{P}_{Dark}(x,y, t_{exp})`$ 。在以下叙述中用 $`N`$ 表示非FPN噪声（随机噪声），对于随机噪声，一般认为对于足够多张拍摄的照片，实际积累的暗电子数 $`k_d`$ 与其平均期望值 $`\mu _d`$ 之间的偏差 $`N_{DS}=K_D-\mu _d`$ 的均值为 $`0`$ （符合泊松分布）。

  - **偏置帧 ( $`P_{Bias}(x,y)`$ )**：在 **零曝光时间** （或相机允许的最短曝光时间）、完全遮光（镜头盖盖上或快门关闭）的条件下拍摄。偏置帧会清除相机中积累的电荷，并读出清除后的 CCD 信号值。生成的图像是低信号值图像，它主要记录了传感器的读出偏置及其空间非均匀性（即Offset FPN，它是DSNU的一部分） ( $`B(x,y)`$ ) ，以及读出噪声 ( $`N_R(x,y)`$ )。对于单次拍摄，忽略随机噪声可直接约等于为：

$$ P_{Bias}(x,y) = B(x,y) + N_{R}(x,y)\approx B(x,y) $$  

&#x2003;&#x2003;&#x2003;&#x2003;或通常使用多帧平均的 **主偏置帧**  $`\bar{P}_{Bias}(x,y)`$  以减小  $`N_R`$  的影响，使其更接近  $`B(x,y)`$ （见前文对于均值的讨论）：
    
$$ \bar P_{Bias}(x,y) \approx B(x,y) $$  

  - **暗场帧 ( $`P_{Dark}(x,y, t_{exp})`$ )**：在与待校正图像（样本图像或平场图像） **相同的曝光时间  $`t_{exp}`$ 、相同的传感器温度、相同的增益设置** 以及完全遮光的条件下拍摄。它记录了偏置  $`B(x,y)`$ 、在曝光时间  $`t_{exp}`$  内累积的平均暗信号  $`D_{S}(x,y, t_{exp})`$ ，以及读出噪声  $`N_R(x,y)`$  和暗电流散粒噪声  $`N_{DS}(x,y, t_{exp})`$ 。同上，对于单次拍摄有：

$$ P_{Dark}(x,y, t_{exp}) = B(x,y) + D_S(x,y, t_{exp}) + N_R(x,y) + N_{DS}(x,y, t_{exp}) \approx B(x,y) + D_S(x,y, t_{exp}) $$  

&#x2003;&#x2003;&#x2003;&#x2003;或者平均后的主暗场帧为（见前文对于均值的讨论）：

$$ \bar P_{Dark}(x,y, t_{exp}) \approx B(x,y) + D_S(x,y, t_{exp}) $$  

&#x2003;&#x2003;&#x2003;&#x2003;其中  $`D_S(x,y, t_{exp})`$  是在  $`(x,y)`$  位置、曝光时间  $`t_{exp}`$  内累积的平均暗信号（以ADU为单位）。

  - 比较暗场帧与偏置帧的式子，我们可以发现：如果样本图像和（或）平场图像的曝光时间非常短，使得累积的暗信号  $`D_S`$  远小于偏置  $`B(x,y)`$  和读出噪声  $`N_R(x,y)`$ ，那么使用**主偏置帧 ( $`\bar{P}_{Bias}`$ )** 作为 $`P_{Bkg}(x,y)`$ 是一个合理的近似，可以简化校准图像的采集。如果曝光时间较长，暗信号的累积不可忽略（即  $`D_S`$  显著），则必须使用与该图像曝光时间、温度、增益完全匹配的 **主暗场帧 ( $`\bar{P}_{Dark}`$ )** 作为  $`P_{Bkg}(x,y)`$ 。这是因为暗场帧不仅包含了偏置信息，还包含了在该曝光条件下累积的暗信号及其空间非均匀性（DSNU中与暗电流相关的部分）。无论是直接忽略时域噪声，或者通过多帧平均减弱时域噪声的影响，我们都可以得到：

$$ P_{Bkg}(x,y) \approx Q(x,y) $$  

- **平场图像：** 对于平场图像，由于平场中信号期待值各点相同且均为小于等于传感器接收上限的某一定值 $`I_{Flat}`$ ，因此每个点实际像素值 $`P_{Flat}(x,y)`$ 就直接反映该位置系统响应系数，即：

$$ P_{Flat}(x,y)=I_{Flat} \cdot F(x,y)+Q_{Flat}(x,y) $$  

- **样本图像：** 对于样品图像中的像素值，假设拍摄样品图像时与拍摄平场图像时可能因为透射光强度或荧光物质性能改变等造成光照不一致，设系数为 $`k`$ （简单假设，未考虑实际成像中仅照明亮度改变可能也会引起系统响应系数改变），对于样品图像的目标信号 $`I_{Raw}(x,y)`$ ，则每个点实际像素值为：

$$ P_{Sample}(x,y)=I_{Raw}(x,y) \cdot k \cdot F(x,y) + Q_{Sample}(x,y) $$  
#### 2.2.2 标准单平场与单暗场矫正算法推导（最常用的）
为简化后续推导，假设用于校正样本图像和校正平场图像的背景条件是匹配的，即如果样本图像用曝光时间为  $`t_S`$  的暗场  $`P_{Dark}(t_S)`$  校正，平场图像用曝光时间为  $`t_F`$  的暗场  $`P_{Dark}(t_F)`$  校正，即在最简单的场景中，如果都用偏置帧校正，或者样本和平场的曝光时间等条件一致（ $`t_S=t_F`$ ），即  $`Q_{Sample}(x,y) = Q_{Flat}(x,y) = Q(x,y)`$  (即都用同一个  $`P_{Dark}(x,y)`$  或  $`P_{Bias}(x,y)`$ )。
根据上述定义，则：

- 想要还原后得到的原始照明条件下的图像为：

$$ P_{Target}(x,y)=I_{Raw}(x,y) \cdot k=\frac{P_{Sample}(x,y)-Q_{Sample}(x,y)}{F(x,y)}=\frac{P_{Sample}(x,y)-Q(x,y)}{P_{Flat}(x,y)-Q(x,y)} \cdot I_{Flat} $$  

- 那么如何得到 $`I_{Flat}`$ 呢？或者说，许多文章中提到的平场图像的像素平均值 $`\bar P_{Flat}`$ 或者样品图像的像素平均值 $`\bar P_{Sample}`$ 或者平场或样品图像减去暗场后的平均值是否就等于 $`I_{Flat}`$ ？

$$ \bar P_{Flat}=I_{Flat}×\frac{1}{N}\sum_{(x,y)}{F(x,y)}+\frac{1}{N}\sum_{(x,y)}{Q(x,y)} =I_{Flat}\bar F+\bar Q $$  

$$ \bar P_{Sample}=\frac{k}{N}\sum_{(x,y)}{[I_{Raw}(x,y)×F(x,y)]}+\bar Q $$  

$$ \bar P_{Bkg}=\bar Q(x,y)=\frac{1}{N}\sum_{(x,y)}{Q(x,y)}=\bar Q $$  

&#x2003;&#x2003;也就是说无论是谁都不等于，至少都会乘上一个系数 $`\bar F`$ 。

- 我们将上述 $`P_{Target}(x,y)`$ 与 $`\bar P_{Flat}`$ 和 $`\bar P_{Dark}`$ 式子联立，可以得到用已知数据计算 $`P_{Corr}(x,y)`$ 的方法为：

$$ P_{Corr}(x,y)=\frac{P_{Sample}(x,y)-P_{Dark}(x,y)}{P_{Flat}(x,y)-P_{Drak}(x,y)}×\frac{\bar P_{Flat}-\bar P_{Bkg}}{\bar F} $$  

&#x2003;&#x2003;其中，仍然包含一个未知数 $`\bar F`$ ，根据我们先前的定义，可知 $`\bar F \in [0,1]`$ ，而当没有暗场图像时，只能约定上述 $`P_{Bkg}`$ （ $`\bar Q`$ ）为 $`0`$ 。也就是说，对于单张平场图像，只有一个方程 $`\bar P_{Flat}=I_{Flat}\bar F+\bar Q`$ ，其中包含两个未知数 $`(I_{Flat},\bar F)`$ ，无法同时解出，所以在只有一张平场图像的情况下，平场校正后的图像 $`P_{Corr}(x,y)`$ 实际上比样本图像像素真值 $`P_{Target}(x,y)`$ 多乘了一个系数 $`\bar F \in [0,1]`$ 的，即实际得到的结果为：

$$ P_{Corr}^{*}(x,y)=I_{Raw}(x,y) \cdot k \cdot \bar F=P_{Target}(x,y) \cdot \bar F $$  

&#x2003;&#x2003;尽管在大部分情况下，可能 $`\bar F \to 1`$ 。
- 不过，只要多张图片使用的是同一张平场图像，则运算中的 $`\bar F`$ 相同，对统计结果趋势没有影响；另一个方面，也就是说 **对于该方法，其实没有要求样本图像和平场图像的光照强度是否相同** （不考虑不同光照强度可能影响 $`F(x,y)`$ 以及因为光照导致的热效应不同导致的噪声模式改变），校正后能还原样本图像拍摄时照明条件（即 $`P_{Target}(x,y)=I_{Raw}(x,y)×k`$ 而非 $`P_{Target}(x,y)=I_{Raw}(x,y)`$ ）。

总而言之，因此，在没有额外信息或绝对校准源的情况下，常规的单平场校正本质上是进行相对响应校正，结果会带有  $`\bar{F}`$ 因子，尽管我们可以通过归一化校准相对量，但本质上都没有还原回原始的绝对亮度。不过，对于许多应用，只要这个因子对于所有被比较的图像是恒定的，它就不影响对物体特征的相对分析和模式识别。该系数的存在实际上也解释了为什么我们在执行完平场校正以后有时候会觉得图像的亮度似乎降低了。

#### 2.2.3 是否有可能恢复图像的“真实亮度”（即消除  $`\bar{F}`$  因子）？

如上所述，标准单平场校正会引入  $`\bar{F}`$  缩放。要得到  $`I_{Raw}(x,y) \cdot k`$  （即  $`P_{Target}(x,y)`$ ），理论上需要消除  $`\bar{F}`$ 。

* **使用已标定的平场光源** ：如果平场光源的有效强度  $`I_{Flat}`$  （即产生平场图像时，在  $`F(x,y)=1`$  条件下本应得到的信号值）是已知的（例如通过辐射定标得到），那么可以使用公式  $`P_{Target}(x,y) = \frac{P_{Sample}(x,y)-Q_{Sample}(x,y)}{P_{Flat}(x,y)-Q_{Flat}(x,y)} \times I_{Flat}`$  来直接计算。但  $`I_{Flat}`$  的精确标定通常很复杂。
* **通过多张不同强度的平场图像** （不能）：
  拍摄两张平场图像  $`P_{Flat1}`$  和  $`P_{Flat2}`$ ，对应光源的真实有效强度为  $`I_{FlatA}`$  和  $`I_{FlatB}`$ （例如， $`I_{FlatB} = c \cdot I_{FlatA}`$ ，其中比例系数  $`c`$  已知，可以通过改变曝光时间或光源设置得到，并假设系统响应线性）。
  

$$ P_{Flat1}'(x,y)=P_{Flat1}(x,y)-Q(x,y) = I_{FlatA} \cdot F(x,y) $$  
$$ P_{Flat2}'(x,y)=P_{Flat2}(x,y)-Q(x,y) = I_{FlatB} \cdot F(x,y) $$  

&#x2003;&#x2003;取平均值：

$$ \bar P_{Flat1}'=P_{Flat1}(x,y)-Q(x,y) = I_{FlatA} \cdot \bar F $$  
$$ \bar P_{Flat2}'=P_{Flat2}(x,y)-Q(x,y) = I_{FlatB} \cdot \bar F $$  

&#x2003;&#x2003;从这两个方程中，如果  $`I_{FlatA}`$  和  $`I_{FlatB}`$  都是未知的，我们仍然无法解出  $`\bar{F}`$  的绝对值。我们只能得到  $`\bar{P}'_{Flat2} / \bar{P}'_{Flat1} = I_{FlatB} / I_{FlatA} = c`$ ，这可以用来验证系统的线性度。

&#x2003;&#x2003;这种方法本身并不能直接解出  $`\bar{F}`$  以用于绝对亮度恢复，除非有一个  $`I_{Flat}`$  的已知参考值。绝对光度定标通常需要更复杂的步骤和标准参考源。

#### 2.2.4 如果没有暗场矫正，直接进行平场校正除法会对样品图像产生的影响

此时实际校正后图像变为：

$$ P_{Corr}^{*'}(x,y)=\frac{P_{Sample}(x,y)}{P_{Flat}(x,y)}×\bar P_{Flat}=\frac{I_{Raw}(x,y) \cdot k \cdot F(x,y) + Q(x,y)}{I_{Flat} \cdot F(x,y)+Q(x,y)}×(I_{Flat}\bar F+\bar Q) $$  

分析这个结果，可以看到以下影响：

- **无法正确消除系统响应因子 F(x,y) 的空间不均匀性** ： 由于分子和分母中都包含了加性项  $`Q_{Sample}(x,y)`$  和 $`Q_{Flat}(x,y)`$ ，尽管可能比较小，但也会导致 $`F(x,y)`$ 无法被完美约去。这意味着由PRNU和照明不均引起的空间非均匀性仍然会一定程度上残留在校正后的图像中，或者被错误地修改。
- **引入新的伪影（Artifacts）** ：
   - 分母中的 $`Q_{Flat}(x,y)`$ （平场的偏置和暗信号图案，即DSNU）会以一种复杂的方式（作为除数的一部分）反作用于图像。如果 $`Q_{Flat}(x,y)`$ 在某些区域值较大（例如热像素或条纹），会导致这些区域在校正图像中信号被不当压低。反之，如果 $`Q_{Flat}(x,y)`$ 偏低，则信号被不当抬高。这相当于将平场图像的DSNU图案以一种扭曲的形式“印”到了样本图像上。
   - 分子中的 $`Q_{Sample}(x,y)`$ （样本的偏置和暗信号图案）没有被去除，它会直接叠加在真实信号上，并参与后续的乘法缩放，使得样本图像自身的DSNU问题依然存在并可能被错误缩放。
- **整体亮度和对比度失真** ： 乘法因子 ( $`\bar P_{Flat}−\bar P_{Dark}`$ ) 在正确校正时是  $`I_{Flat} \cdot \bar F`$ ，用于恢复一定的亮度尺度。但在没有暗场校正时，乘法因子变为  $`\bar P_{Flat}=I_{Flat} \cdot \bar F+Q_{Flat}`$ 。这个额外的 $`\bar Q_{Flat}`$ 会导致最终图像的整体亮度和对比度与期望值产生偏差。
- **固定模式噪声（FPN）的恶化** ： 由于DSNU（ $`Q_{Sample}(x,y)`$ 和 $`Q_{Flat}(x,y)`$ 中的空间不均匀部分）没有被正确处理，这些固定模式噪声不仅不会被消除，反而可能因为错误的运算（如除法和乘法）而被放大或扭曲，使得最终图像的FPN问题更加严重。

如果不进行暗场校正（即不扣除 $`P_{Dark}(x,y)`$ 或相应的 $`Q(x,y)`$ ），直接套用类似的平场校正逻辑进行除法运算，会导致无法有效去除系统响应的空间不均匀性（PRNU和照明不均），同时会引入由平场图像和样本图像自身的偏置、暗信号及其不均匀性（DSNU）造成的伪影和失真，图像质量将下降。我们之前对于如果没有拍摄暗场照片，则约定 $`P_{Bkg}`$ （ $`\bar Q`$ ）为 $`0`$ ，因此，只有当提前知道暗场FPN非常轻微时，不进行暗场矫正才有可能得到相对视觉上正确的矫正图像。

#### 2.2.5 考虑随机噪声的影响下，仅进行单张平场校正时随机噪声对于样本图像的影响

之前的讨论都是在没有考虑随机噪声的影响下进行矫正，现在考虑在进行正确的暗场校正（即扣除  $`P_{Dark}`$  项）的前提下，随机噪声对校正结果的影响。
校正公式为：

$$ P_{Corr}^{*''}(x,y)=\frac{P_{Sample}(x,y)-P_{Dark\_S}(x,y)}{P_{Flat}(x,y)-P_{Dark\_F}(x,y)} \times [\bar P_{Flat}(x,y)-\bar P_{Dark\_F}(x,y)] $$  

这里为了更精确，我们区分用于样本的暗场  $`P_{Dark\_S}`$  和用于平场的暗场  $`P_{Dark\_F}`$ 。 $`\bar P_{Flat}(x,y)-\bar P_{Dark\_F}(x,y)`$ 即为  $`\bar{P}'_{Flat}`$ 。

让各原始图像包含其信号均值部分和该次拍摄的随机噪声实现：
*  $`P_{Sample}(x,y) = (I_{Raw}(x,y)kF(x,y) + Q_S(x,y)) + N_{Sample\_raw}(x,y)`$ 
*  $`P_{Dark\_S}(x,y) = Q_S(x,y) + N_{Dark\_S\_raw}(x,y)`$ 
*  $`P_{Flat}(x,y) = (I_{Flat}F(x,y) + Q_F(x,y)) + N_{Flat\_raw}(x,y)`$ 
*  $`P_{Dark\_F}(x,y) = Q_F(x,y) + N_{Dark\_F\_raw}(x,y)`$ 

其中， $`N_{Sample\_raw}`$  包含光子散粒噪声和读出噪声； $`N_{Dark\_S\_raw}`$  包含暗电流散粒噪声和读出噪声； $`N_{Flat\_raw}`$  包含光子散粒噪声（来自平场光源）、读出噪声； $`N_{Dark\_F\_raw}`$  包含暗电流散粒噪声和读出噪声。

将上述包含随机噪声的式子带入矫正式：
* 分子项： $`N_{um}(x,y) = (P_{Sample}(x,y)-P_{Dark\_S}(x,y)) = I_{Raw}(x,y)kF(x,y) + (N_{Sample\_raw}(x,y) - N_{Dark\_S\_raw}(x,y))`$ 
    令  $`N'_{Sample}(x,y) = N_{Sample\_raw}(x,y) - N_{Dark\_S\_raw}(x,y)`$ 。这是一个新的复合随机噪声项，则原分子项表示为： $`N_{um}(x,y) = I_{Raw}(x,y)kF(x,y) + N'_{Sample}(x,y)`$ 。
* 分母项： $`D_{enom}(x,y) = (P_{Flat}(x,y)-P_{Dark\_F}(x,y)) = I_{Flat}F(x,y) + (N_{Flat\_raw}(x,y) - N_{Dark\_F\_raw}(x,y))`$ 
    令  $`N'_{Flat}(x,y) = N_{Flat\_raw}(x,y) - N_{Dark\_F\_raw}(x,y)`$ ，则原分子项表示为： $`D_{enom}(x,y) = I_{Flat}F(x,y) + N'_{Flat}(x,y)`$ 。
* 乘法因子（缩放因子  $`M`$ ）： $`M = \text{mean}(D_{enom}(x,y)) = \text{mean}(I_{Flat}F(x,y) + N'_{Flat}(x,y))`$ 
    由于随机噪声  $`N'_{Flat}(x,y)`$  在全图平均后其均值接近于0（尤其当像素数量很多时），所以  $`M \approx \text{mean}(I_{Flat}F(x,y)) = I_{Flat}\bar{F}`$ 。（严格来说， $`M`$  本身也会因为  $`N'_{Flat}`$  的存在而有一个微小的随机波动，但如果校准帧是通过多帧平均得到的“主帧”， $`N'_{Flat}`$  会很小，  $`M`$  的波动也会很小。）

校正公式变为：

$$ P_{Corr}^{*''}(x,y) \approx \frac{I_{Raw}(x,y)kF(x,y) + N_{Sample}'(x,y)}{I_{Flat}F(x,y) + N_{Flat}'(x,y)} \times I_{Flat}\bar{F} $$  

**分析随机噪声的影响：**

- **噪声的传播**
  
  - 令  $`S_S(x,y) = I_{Raw}(x,y)kF(x,y)`$  ，令 $`S_F(x,y) = I_{Flat}F(x,y)`$ ，则原式化为：

$$ P_{Corr}^{*''}(x,y) \approx \frac{S_S(x,y) + N_{Sample}'(x,y)}{S_F(x,y) + N_{Flat}'(x,y)} \times M $$  

  - **上述式子很难看出随机噪声** $`N`$  **如何影响最终结果。为了显示随机噪声的影响** ，我们将分母转换为  $`S_F(x,y)\left(1 + \frac{N'_{Flat}(x,y)}{S_F(x,y))}\right)`$ 的形式。如果  $`N'_{Flat}(x,y)`$  相对于  $`S_F(x,y)`$  较小，则其倒数近似为  $`\frac{1}{S_F(x,y)}\left(1 - \frac{N'_{Flat}(x,y)}{S_F(x,y)}\right)`$ （二项式定理，令 $`x=\frac{N'_{Flat}(x,y)}{S_F(x,y)}`$ ，取前两项为 $`(1+x)^{-1} \approx 1-x`$ ），则原式可化为：

$$
\begin{aligned}
    P_{Corr}^{*''}(x,y) &\approx \left( \frac{S_S(x,y)}{S_F(x,y)} + \frac{N_{Sample}'(x,y)}{S_F(x,y)} \right) \left( 1 - \frac{N_{Flat}'(x,y)}{S_F(x,y)} \right) \times M\\
    &\approx\left( \frac{S_S(x,y)}{S_F(x,y)} - \frac{S_S(x,y)N_{Flat}'(x,y)}{S_F(x,y)^2} + \frac{N_{Sample}'(x,y)}{S_F(x,y)} \right) \times M\text{ (同理，忽略了}N_{Sample}' \cdot N_{Flat}'\text{这样的二阶小量)}
\end{aligned}
$$

  - 代回  $`S_S, S_F, M`$ :
        
$$
\begin{aligned}
        P_{Corr}^{*''}(x,y) &\approx \left( \frac{I_{Raw}kF}{I_{Flat}F} - \frac{I_{Raw}kF \cdot N_{Flat}'}{(I_{Flat}F)^2} + \frac{N_{Sample}'}{I_{Flat}F} \right) \times I_{Flat}\bar{F}\\
        &= \left( \frac{I_{Raw}k}{I_{Flat}} - \frac{I_{Raw}k \cdot N_{Flat}'}{I_{Flat}^2 F} + \frac{N_{Sample}'}{I_{Flat}F} \right) \times I_{Flat}\bar{F}\\
        &= I_{Raw}k\bar{F} - \frac{I_{Raw}k\bar{F} \cdot N_{Flat}'}{I_{Flat}F} + \frac{\bar{F} \cdot N_{Sample}'}{F}
\end{aligned}
$$


&#x2003;&#x2003;上式仅在  $`N'_{Flat}(x,y)`$ 远小于 $`S_F(x,y)`$ 时成立（即平场图像的随机噪声非常小时）。如果近似条件不满足，则线性误差传播分析会失效，校正结果的噪声特性会更复杂，并且在 $`S_F(x,y)`$  很小的区域，校正本身可能会引入巨大的误差和噪声。
    
- **最终图像中的噪声来源** ：
    校正后的图像  $`P_{Corr}(x,y)`$  的理想值是  $`I_{Raw}k\bar{F}`$ 。实际结果会叠加一个由  $`N'_{Sample}`$  和  $`N'_{Flat}`$  引入的复合噪声。
    
    * **来自样本图像的噪声 ( $`N'_{Sample}`$ )** ：样本图像及其对应暗场的随机噪声差 ( $`N_{Sample\_raw} - N_{Dark\_S\_raw}`$ ) 会被因子  $`\bar{F}/F(x,y)`$  （即  $`1/F_{Norm}(x,y)`$ ）缩放后叠加到最终图像上。这意味着：
        * 在系统响应  $`F(x,y)`$  较低的区域（例如暗角、灰尘处，导致  $`F_{Norm}(x,y)`$  较小），这部分噪声会被 **放大** 。
        * 在系统响应  $`F(x,y)`$  较高的区域（ $`F_{Norm}(x,y)`$  较大），这部分噪声会被 **相对抑制** 。
    * **来自平场图像的噪声 ( $`N'_{Flat}`$ )** ：平场图像及其对应暗场的随机噪声差 ( $`N_{Flat\_raw} - N_{Dark\_F\_raw}`$ ) 会被一个更复杂的因子（大致为  $`\frac{I_{Raw}k\bar{F}}{I_{Flat}F(x,y)}`$  或  $`\frac{I_{Raw}k}{I_{Flat}F_{Norm}(x,y)}`$ ）缩放后贡献到最终图像的噪声中。这意味着：
        * 平场图像的噪声对最终结果的影响，不仅取决于平场自身信噪比，还取决于样本信号的强度 ( $`I_{Raw}k`$ ) 和平场光源的强度 ( $`I_{Flat}`$ )。
        * 同样，在系统响应  $`F(x,y)`$  较低的区域，这部分噪声的贡献也会被放大。
    
- **信噪比的降低** ：
    由于除法操作会放大分母中噪声的相对影响（特别是在分母本身较小的区域），平场校正通常会导致图像某些区域的信噪比(SNR)相比原始未校正图像（如果只考虑光子散粒噪声）有所下降。最终图像的噪声是原始样本图像噪声、原始暗场噪声、原始平场噪声以及用于平场的暗场噪声共同传播和叠加的结果。

- **使用主校准帧的重要性** ：
    为了最大限度地减小随机噪声的影响，实际操作中：
    
    *  $`P_{Dark\_S}`$  和  $`P_{Dark\_F}`$  应使用多帧平均得到的“主暗场/主偏置帧”，这会使得  $`N_{Dark\_S\_raw}`$  和  $`N_{Dark\_F\_raw}`$  的方差减小  $`N_d`$  倍（ $`N_d`$ 为平均的暗场帧数）。
    *  $`P_{Flat}`$  也应使用多帧原始平场（每帧都已扣除其对应的主暗场/偏置）平均得到的“主平场”，这会使得主平场中的  $`(N_{Flat\_raw} - N_{Dark\_F\_raw})`$  的随机部分显著降低。
    通过这些平均操作，可以使得  $`N'_{Sample}`$  和  $`N'_{Flat}`$  中的噪声贡献（尤其是来自校准帧的噪声）大大减小，从而提高最终校正图像的质量。如果使用单帧的校准图像，其自身的随机噪声会严重污染校正结果。

**总结** ：随机噪声通过校正公式的除法和乘法运算传播到最终图像中。样本图像的噪声和平场图像（及其对应暗场）的噪声都会贡献于最终结果的噪声。系统响应因子  $`F(x,y)`$  较小的区域（图像中较暗的平场区域）对噪声的放大效应尤为明显。因此，使用高信噪比的（即多帧平均的）主校准帧对于高质量的平场和暗场校正至关重要。

<br/>

## 3. 总结

### 3.1 标准平场校正
基于之前的讨论，标准的平场与暗场（或偏置）校正算法具有以下特点：

#### 3.1.1 特点：

1.  **校正乘性效应** ：平场校正的核心目的是校正由系统响应因子  $`F(x,y)`$  引入的乘性效应，这包括了像素光响应非均匀性（PRNU）和整个光学系统（镜头、滤镜、光源等）造成的照明不均匀性。
2.  **需要加性效应校正** ：为了准确校正乘性效应，必须首先通过减去暗场帧（或偏置帧） $`P_{Dark}(x,y)`$  来去除加性效应，即偏置  $`B(x,y)`$  和曝光时间内累积的暗信号  $`D_S(x,y, t_{exp})`$  及其空间不均匀性（DSNU）。
3.  **对光照强度匹配的非强制性** ：
    * 如推导结果  $`P_{Corr}(x,y) = I_{Raw}(x,y) \cdot k \cdot \bar{F}`$  所示，校正后的图像强度正比于样本原始信号  $`I_{Raw}(x,y) \cdot k`$ ，并乘以一个常数  $`\bar{F}`$ （系统平均响应）。平场图像拍摄时的光源绝对强度  $`I_{Flat}`$  在计算比率  $`\frac{P_{Sample}-P_{Dark}}{P_{Flat}-P_{Dark}}`$  时被约去（如果将乘数视为  $`\text{mean}(P_{Flat}-P_{Dark})`$ ）。
    * 这意味着，理论上，用于校正的平场图像的光照强度 **不需要** 与样本图像的光照强度完全一致。只要两者都在传感器的线性响应范围内，并且光源的光谱特性和光路几何与样本成像时一致（或能等效代表  $`F(x,y)`$ ），校正就能有效地消除空间不均匀性。最终结果的整体亮度会受到  $`\bar{F}`$  和所使用的乘数（通常是  $`\text{mean}(P_{Flat}-P_{Dark})`$ ）的影响。
4.  **明场平场对荧光图像的理论适用性** ：
    *  $`F(x,y)`$  代表的是系统整体的光学和光电转换特性。如果荧光成像中，激发光路和发射光路共用大部分光学元件（如物镜、相机接口、传感器本身），并且  $`F(x,y)`$  的主要不均匀性来源（如传感器PRNU、靠近传感器的镜片上的灰尘）对于激发光和发射光的影响相似，或者发射光的波长范围相对较窄且在该范围内  $`F(x,y)`$  变化不大，那么用明场条件下拍摄的平场图像（其光源覆盖了荧光发射的波段，或者系统响应对波长不敏感）来校正荧光图像中的这些不均匀性，理论上是可行的。
    * 然而，实际中  $`F(x,y)`$  往往是波长依赖的（例如，不同波长的光在光学元件上的透过/反射率不同，传感器的量子效率也随波长变化）。因此，最理想的平场校正应使用与被测信号波长和光路尽可能匹配的平场。对于多色荧光，可能需要针对不同发射波段分别进行平场校正。

#### 3.1.2 缺点：

1.  **引入并放大随机噪声** ：
    * 如前所述，校正公式涉及除法运算。原始平场图像  $`P_{Flat}`$  及其对应的暗场  $`P_{Dark\_F}`$  本身都包含随机噪声（读出噪声、暗电流散粒噪声、光子散粒噪声）。这些噪声会传递到计算出的校正因子中（例如  $`F_{Norm}(x,y)`$ ），并在用样本图像  $`(P_{Sample}-P_{Dark\_S})`$  除以该校正因子时，被引入并可能放大到最终的  $`P_{Corr}`$  图像中。
    * 特别地，在平场图像信号较低的区域（即  $`F(x,y)`$  值较小的区域，如暗角或污渍阴影处），除法运算会显著放大噪声，导致校正后图像在这些区域的信噪比严重恶化。
    * **缓解方法** ：
        * 拍摄多帧原始平场图像和多帧原始暗场/偏置图像，分别平均生成“主平场”和“主暗场/偏置场”。平均过程可以显著降低校准帧自身的随机噪声（噪声幅度按  $`\sqrt{N_{frames}}`$  因子降低），从而减少引入到最终样本图像中的噪声。
        * 对于使用电子倍增CCD（EMCCD）等具有内部增益的探测器，在拍摄平场图像时，适当调整EM增益值，可以在保持信号足够高的同时，将信号放大到高于读出噪声的水平，从而提高平场图像本身的信噪比。

2.  **处理高对比度污渍（如暗尘埃颗粒）效果不佳** ：
    * 当存在对比度非常高（几乎不透光）的污渍时， $`F(x,y)`$  在污渍处的值会非常接近于零。这导致校正因子  $`F_{Norm}(x,y)`$  在相应位置也接近于零。
    * 用一个正常的样本信号除以一个接近零的校正因子，会导致结果出现极大值（溢出）或极不稳定的高噪声，无法正确校正污渍。
    * 例如之前讨论的情况，这正是这类算法在面对此类污渍时表现不佳的原因。

3.  **当需要矫正的内容中除了光照不均还包含一些高频颗粒或大块污渍时，对准精度要求极高，轻微位移导致伪影（光晕/暗边）** ：
    * 平场校正严格依赖于平场图像中的不均匀性特征（如灰尘、划痕、固定模式）与样本图像中这些特征在传感器上的物理位置完全对应。
    * 如果拍摄平场后，光学系统有任何微小的扰动（例如，移动了样品载台导致光路轻微变化，或传感器上的灰尘颗粒发生了微小位移，或者焦面改变可能导致的污渍变化），导致平场图像中的污渍位置与样本图像中的污渍位置有像素级的错位，那么在污渍边缘进行除法校正时就会出错：
        * 样本图像中污渍边缘的正常信号区域，可能会除以平场图像中污渍中心（校正因子极低）的值，产生人为的亮边或光晕。
        * 样本图像中污渍中心的低信号区域，可能会除以平场图像中污渍边缘（校正因子较高）的值，导致校正不足，而其旁边正常区域若除了较低的校正因子则被过度放大。
    * 这种现象在高对比度、边缘锐利的污渍处尤为严重。

4.   $`\bar{F}`$  **因子导致的亮度缩放** ：
    * 如前所述，标准的平场校正结果为  $`I_{Raw}(x,y) \cdot k \cdot \bar{F}`$ ，其中  $`\bar{F}`$  是系统平均响应因子。这意味着校正后的图像的绝对亮度被  $`\bar{F}`$  缩放了（通常是衰减，因为  $`\bar{F} \le 1`$ ）。虽然这不影响相对强度分析，但如果需要绝对光度测量，则需要进一步校准或已知  $`\bar{F}`$ 。

### 3.2 针对特定污渍移除的方法（该方法）的讨论

#### 3.2.1 方法特点、优点与缺点

相比于平场校正本质上更多的用途是用来做光照不均矫正的（至少从主要的用途上来说更多的是这个，尽管也能实现污渍移除），本方法主要就只关注污渍移除，核心步骤是通过处理平场图像来提取污渍特征，然后根据污渍在样本图像和平场图像中的相对“强度”关系，对样本图像进行 **加性校正** 。本方法并没有处理光照不均矫正，因此对于普通平场校正移除污渍效果不佳的图像，使用该方法校正后，你可能需要再执行一次伪平场校正以对光照不均进行校正。

**优点** ：

* **针对性处理高对比度污渍** ：对于传统平场校正难以处理的对比度非常高、局部化的暗污渍，该方法通过“填补”而非“除法恢复”的思路，可能避免数值不稳定和噪声过度放大，从而获得视觉上更好的效果。
* **可能降低对精确对准的极端敏感性** ：由于其校正是基于从平场中识别出的污渍区域特征，并通过加法补偿，对于污渍边缘的轻微亚像素位移，其产生的伪影可能不像传统方法的除法运算那样剧烈。
* **自动化潜力** ：为去除特定类型的、可识别的污渍提供了一种自动化的解决方案。
* **对于平场图像噪点的低引入** ：根据我们之前的讨论，普通平场校正会将平场图像中的随机噪声引入样品图像，本方法本质上对样品图像操作的部分只包含了污渍区域，因此从量上来说，本方法相对只会引入更少的平场图像中随机噪声，对画面整体的影响更少。

**缺点** ：

* **加性校正的局限性** ：如下文将详细讨论的，许多物理污渍效应是乘性的（或者说，许多物理污渍同时具有加性和乘性均有的性质）。加性校正仅在特定条件下（如污渍对比度低，或样本与平场背景光强相似）才能较好地近似乘性效应。
* **依赖污渍特征提取的准确性** ：背景扣除、阈值分割等步骤对参数敏感，可能影响污渍掩模的准确性和后续校正。
* **未处理全局不均匀性** ：该方法主要针对局部污渍，不能替代传统平场校正来解决全局的PRNU和照明不均问题。
* **未考虑暗场/偏置校正的影响** ：如果输入的平场图像和平场样本图像未经过暗场/偏置校正，其自身的DSNU可能会被误认为污渍或干扰污渍校正。

#### 3.2.2 物理污渍到底是加性的还是乘性的

* **完全遮光的物理污渍（如不透明的灰尘颗粒）** ：
    这类污渍的效应本质上是 **乘性的** 。它们像微小的障碍物一样，几乎完全阻挡了光线到达传感器特定区域。如果该区域的透光率为  $`T_{stain}(x,y)`$ （对于完全不透明的灰尘， $`T_{stain} \approx 0`$ ），那么在该污渍处的观察信号  $`P'_{stain}`$  与无污渍时的理想信号  $`P'_{ideal}`$  的关系是  $`P'_{stain}(x,y) = P'_{ideal}(x,y) \cdot T_{stain}(x,y)`$ 。传统的平场校正正是试图通过除以一个与  $`T_{stain}(x,y)`$  相关的归一化因子来恢复  $`P'_{ideal}(x,y)`$ 。但如前所述，当污渍的透光率因子接近零时，除法变得不稳定，这可能是在一些非常显著且不透光的污渍上，该方法的视觉效果（尤其是边缘）比经典平场校正移除污渍效果好的原因。

* **不完全遮光的物理污渍（如半透明的污迹、薄尘、干涸的盐渍边缘等）** ：
    这类污渍的效应通常也是 **乘性的** ，其透光率  $`T_{stain}(x,y)`$  在0和1之间。它们会使通过的光线强度按一定比例衰减， $`P'_{stain}(x,y) = P'_{ideal}(x,y) \cdot T_{stain}(x,y)`$ 。

* **液体中的晕影（如细胞培养液的弯月面、盖玻片边缘的液体折射产生的暗环或亮环）** ：
    这类现象更为复杂，可能同时包含 **乘性和加性（或更复杂的散射/折射）效应** ：
    * **乘性效应** ：液体本身对光的吸收或散射可能导致光强按比例衰减。液体边缘形成的类似透镜的结构，可能使部分区域光线会聚（局部变亮，等效  $`F(x,y)>1`$ ）或发散（局部变暗，等效  $`F(x,y)<1`$ ），这些都可以看作是局部的乘性调制。
    * **加性效应（较少见，但可能存在）** ：如果液体本身有微弱的自发荧光或散射了环境中的杂散光进入光路，这部分信号可能会以加性的方式叠加到图像上。但对于由折射和吸收为主导的“晕影”，其主要影响还是对原有光路的调制（乘性）。
    * 简单的说，晕影通常是由于光线路径的改变（折射）和部分吸收/散射造成的，这使得落在传感器某些区域的光通量发生了变化，这种变化与该区域原本应接收到的光通量是相关的，因此更偏向于乘性效应。

#### 3.2.3 关于该方法本质的讨论

该方法本质虽然可能也相当于就是用明场图像弄了一张暗场图像出来然后通过加减法，而暗场矫正也是做加减法，但实际上而这件仍然存在区别：

* **相似之处（都是加/减法校正）** ：
    * 新方法最终通过 **加法** （因为之前对平场做了反相，污渍处变亮）来“填补”样本图像中由污渍造成的暗区。
    * 暗场校正也是通过 **减法** 来去除偏置和暗信号这些加性成分。
      从运算形式上看，都是对原图进行加/减某个图像的操作。

* **本质区别** ：
    * **校正对象不同** ：
        * **暗场校正**去除的是 **传感器自身产生** 的、不依赖于外部照明的信号（偏置、热电子）。这些信号是系统固有的“背景”。
        * **新方法**去除的是 **外部物理遮挡或光学效应** （污渍）对入射光信号的衰减或调制。它处理的是光信号在到达传感器之前的损失。
    * **“校准图像”的来源和含义不同** ：
        * **暗场图像** 是通过在无光条件下拍摄得到的，直接反映了传感器的内在“暗”特性。
        * 新方法中用于“加回”的那个“污渍补偿图”（由平场图像处理得到，例如  $`k_{stain} \cdot S_F'(x,y)`$ ）并非传感器自身产生的信号，而是对“因污渍而损失的信号”的一种估计。它是从一个 **有光照的** 平场图像中间接提取出来的，代表了光路中特定遮挡物的“负面影响”的反向。
    * **物理意义不同** ：
        * 暗场校正的减法是减去一个真实存在的、不必要的信号。
        * 新方法的加法是试图补偿一个本应存在但被遮挡的信号。

所以，虽然运算形式上都是加/减，但新方法更像是一种 **针对特定缺陷的图像修复或补偿** ，而不是传统意义上消除传感器自身固有信号的暗场校正。它从明场图像（平场）中提取了“缺陷的形态和相对强度信息”，然后用这个信息去“修补”样本图像中由同样缺陷造成的问题。可以看作是“用光明照亮缺陷，再用缺陷的‘反影’去修复阴影”。

总而言之，一个物理污渍，其**物理本质是乘性衰减**，而针对这种信号衰减的情况，虽然从可能上应该考虑同样用乘性的方法进行回复，但由于之前讨论中提到的一系列问题（例如随机噪点的引入、对于污渍位置精确性的限定），我们也可以考虑另一种有效的 **修复策略可以是加性的“填补”或“补偿”** 。

<br/>

-------

<br/>

## 示意图来源
https://www.teledynevisionsolutions.com/learn/learning-center/machine-vision/how-to-evaluate-camera-sensitivity/

EMVA 1288 4.0 (https://www.emva.org/standards-technology/emva-1288/emva-standard-1288-downloads-2/)


## 本文档版权声明
**除引用内容外，本文档（特指该README.md）由龙凌洛版权所有，根据 CC BY-NC 4.0 许可。**

**Except for the quoted content, this document (specifically README.md) is copyrighted by Lingluo Long. Licensed under CC BY-NC 4.0. To view a copy of this license, visit https://creativecommons.org/licenses/by-nc/4.0/**


## 主要参考资料

[^1]: https://en.wikipedia.org/wiki/Dark_current_(physics)

[^2]:https://www.allaboutcircuits.com/technical-articles/dark-noise-ccd-image-sensors/

[^3]: https://forum.image.sc/t/proper-way-of-going-about-flat-field-shading-correction/48914/4

[^3]: Camera Sensitivity：https://www.teledynevisionsolutions.com/learn/learning-center/imaging-fundamentals/camera-sensitivity/

Camera Gain：https://www.teledynevisionsolutions.com/learn/learning-center/imaging-fundamentals/camera-gain/

DSNU 和 PRNU：https://www.teledynevisionsolutions.com/learn/learning-center/imaging-fundamentals/pattern-noise-dsnu-and-prnu/

成像原理：https://bbs.imufu.cn/thread-818215-1-1.html

平场与暗场矫正讨论：https://www.cloudynights.com/topic/801978-flat-frame-overcorrection-help/#entry12243666

平场校正一般方法介绍：https://web.archive.org/web/20130407013841/http://www.princetoninstruments.com/cms/index.php/ccd-primer/152-flat-field-correction

温度对随机噪声的影响：https://www.thorlabs.com/newgrouppage9.cfm?objectgroup_id=10773

光电转换与ADU：https://physics.stackexchange.com/questions/149516/what-are-adu-analog-to-digital-units

如何拍摄平场图像：https://calm.ucsf.edu/how-acquire-flat-field-correction-images

另一种表述的原理推导：https://blog.csdn.net/zhuguiqin1/article/details/130348762

Rolling ball半径选择1：http://www.alifescience.com/esoterica/489.html

Rolling ball半径选择2：http://www.alifescience.com/esoterica/490.html
